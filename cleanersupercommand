#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <fcntl.h>
#include <unistd.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <dirent.h>
#include <time.h>
#include <termios.h>

// Constants
#define MAX_BUFFER_SIZE 1024
#define DEFAULT_FILE_PERMS 0644
#define DEFAULT_DIR_PERMS 0755

// Function declarations
void runMenuSystem(void);
void handleFileOperations(int operationType, const char* primaryArg, const char* secondaryArg);
void handleDirectoryOperations(int operationType, const char* dirPath);
void startKeylogger(const char* logFilePath);
void displayMainMenu(void);

typedef enum {
    FILE_CREATE = 1,
    FILE_CHANGE_PERMISSION,
    FILE_READ,
    FILE_WRITE,
    FILE_DELETE
} FileOperationType;

typedef enum {
    DIR_CREATE = 1,
    DIR_REMOVE,
    DIR_PRINT_CURRENT,
    DIR_LIST
} DirectoryOperationType;

int main(int argc, char* argv[]) {
    if (argc == 1) {
        runMenuSystem();
        return 0;
    }

    if (strcmp(argv[1], "-m") != 0) {
        printf("Invalid arguments. Use the following format:\n");
        printf("./supercommand -m <mode> <operation> <args>\n");
        return 1;
    }

    int mode = atoi(argv[2]);
    switch (mode) {
        case 1:
            handleFileOperations(atoi(argv[3]), argv[4], argv[5]);
            break;
        case 2:
            handleDirectoryOperations(atoi(argv[3]), argv[4]);
            break;
        case 3:
            startKeylogger(argv[3]);
            break;
        default:
            printf("Invalid mode selected!\n");
            return 1;
    }

    return 0;
}

void runMenuSystem(void) {
    int choice;
    char primaryArg[MAX_BUFFER_SIZE];
    char secondaryArg[MAX_BUFFER_SIZE];

    while (1) {
        displayMainMenu();
        printf("Enter your choice: ");
        if (scanf("%d", &choice) != 1) {
            while (getchar() != '\n'); // Clear input buffer
            printf("Invalid input! Please enter a number.\n");
            continue;
        }

        switch (choice) {
            case 1: {
                int subChoice;
                printf("File Operations:\n"
                       "1. Create File\n"
                       "2. Change Permission\n"
                       "3. Read File\n"
                       "4. Write File\n"
                       "5. Delete File\n");
                printf("Enter your choice: ");
                scanf("%d", &subChoice);
                printf("Enter file name (and path if required): ");
                scanf("%s", primaryArg);

                if (subChoice == FILE_CHANGE_PERMISSION) {
                    printf("Enter permission (e.g., 0644): ");
                    scanf("%s", secondaryArg);
                }
                handleFileOperations(subChoice, primaryArg, 
                                   subChoice == FILE_CHANGE_PERMISSION ? secondaryArg : NULL);
                break;
            }
            case 2: {
                int subChoice;
                printf("Directory Operations:\n"
                       "1. Create Directory\n"
                       "2. Remove Directory\n"
                       "3. Print Current Directory\n"
                       "4. List Directory\n");
                printf("Enter your choice: ");
                scanf("%d", &subChoice);

                if (subChoice <= DIR_REMOVE) {
                    printf("Enter directory name (and path if required): ");
                    scanf("%s", primaryArg);
                }
                handleDirectoryOperations(subChoice, subChoice <= DIR_REMOVE ? primaryArg : NULL);
                break;
            }
            case 3: {
                printf("Keylogger Operations:\nEnter log file name (e.g., keylog.txt): ");
                scanf("%s", primaryArg);
                startKeylogger(primaryArg);
                break;
            }
            case 0:
                printf("Exiting...\n");
                return;
            default:
                printf("Invalid choice!\n");
        }
    }
}

void handleFileOperations(int operationType, const char* primaryArg, const char* secondaryArg) {
    int fileDescriptor;

    switch (operationType) {
        case FILE_CREATE:
            fileDescriptor = open(primaryArg, O_CREAT | O_WRONLY, DEFAULT_FILE_PERMS);
            if (fileDescriptor == -1) {
                perror("Error creating/opening file");
                return;
            }
            printf("File %s created/opened successfully.\n", primaryArg);
            close(fileDescriptor);
            break;

        case FILE_CHANGE_PERMISSION: {
            mode_t newPerms = strtol(secondaryArg, NULL, 8);
            if (chmod(primaryArg, newPerms) == -1) {
                perror("Error changing file permissions");
                return;
            }
            printf("Permissions of file %s changed to %s.\n", primaryArg, secondaryArg);
            break;
        }

        case FILE_READ:
            fileDescriptor = open(primaryArg, O_RDONLY);
            if (fileDescriptor == -1) {
                perror("Error opening file for reading");
                return;
            }
            {
                char buffer[MAX_BUFFER_SIZE];
                ssize_t bytesRead;
                while ((bytesRead = read(fileDescriptor, buffer, sizeof(buffer))) > 0) {
                    write(STDOUT_FILENO, buffer, bytesRead);
                }
                printf("\n");
                close(fileDescriptor);
            }
            break;

        case FILE_WRITE:
            fileDescriptor = open(primaryArg, O_WRONLY | O_APPEND);
            if (fileDescriptor == -1) {
                perror("Error opening file for writing");
                return;
            }
            {
                char buffer[MAX_BUFFER_SIZE];
                printf("Enter text to write to the file: ");
                scanf(" %[^\n]", buffer);
                write(fileDescriptor, buffer, strlen(buffer));
                printf("Text written to file %s.\n", primaryArg);
                close(fileDescriptor);
            }
            break;

        case FILE_DELETE:
            if (unlink(primaryArg) == -1) {
                perror("Error deleting file");
                return;
            }
            printf("File %s deleted successfully.\n", primaryArg);
            break;

        default:
            printf("Invalid file operation!\n");
    }
}

void handleDirectoryOperations(int operationType, const char* dirPath) {
    switch (operationType) {
        case DIR_CREATE:
            if (mkdir(dirPath, DEFAULT_DIR_PERMS) == -1) {
                perror("Error creating directory");
                return;
            }
            printf("Directory %s created successfully.\n", dirPath);
            break;

        case DIR_REMOVE:
            if (rmdir(dirPath) == -1) {
                perror("Error removing directory");
                return;
            }
            printf("Directory %s removed successfully.\n", dirPath);
            break;

        case DIR_PRINT_CURRENT: {
            char currentPath[MAX_BUFFER_SIZE];
            if (getcwd(currentPath, sizeof(currentPath)) == NULL) {
                perror("Error getting current directory");
                return;
            }
            printf("Current Directory: %s\n", currentPath);
            break;
        }

        case DIR_LIST: {
            DIR* dir = opendir(dirPath ? dirPath : ".");
            if (dir == NULL) {
                perror("Error opening directory");
                return;
            }

            printf("Directory contents:\n");
            struct dirent* entry;
            while ((entry = readdir(dir)) != NULL) {
                printf("%s\n", entry->d_name);
            }
            closedir(dir);
            break;
        }

        default:
            printf("Invalid directory operation!\n");
    }
}

void startKeylogger(const char* logFilePath) {
    pid_t pid = fork();
    if (pid == -1) {
        perror("Error creating process");
        return;
    }

    if (pid == 0) { // Child process (keylogger)
        int logFileDescriptor = open(logFilePath, O_CREAT | O_WRONLY | O_APPEND, DEFAULT_FILE_PERMS);
        if (logFileDescriptor == -1) {
            perror("Error opening log file");
            exit(1);
        }

        // Write timestamp to log file
        time_t currentTime = time(NULL);
        dprintf(logFileDescriptor, "Session started: %s\n", ctime(&currentTime));

        // Configure terminal settings
        struct termios oldTerminal, newTerminal;
        tcgetattr(STDIN_FILENO, &oldTerminal);
        newTerminal = oldTerminal;
        newTerminal.c_lflag &= ~(ECHO | ICANON); // Disable echo and canonical mode
        tcsetattr(STDIN_FILENO, TCSANOW, &newTerminal);

        // Capture keystrokes
        char keystroke;
        while (1) {
            if (read(STDIN_FILENO, &keystroke, 1) == 1) {
                if (keystroke == '\n') {
                    write(logFileDescriptor, "\n", 1);
                } else {
                    write(logFileDescriptor, &keystroke, 1);
                }
            }
        }

        // Cleanup (unreachable in current implementation)
        tcsetattr(STDIN_FILENO, TCSANOW, &oldTerminal);
        close(logFileDescriptor);
        exit(0);
    } else {
        printf("Keylogger is running in the background. Log file: %s\n", logFilePath);
    }
}

void displayMainMenu(void) {
    printf("\nMain Menu:\n"
           "1. File Operations\n"
           "2. Directory Operations\n"
           "3. Keylogger\n"
           "0. Exit\n");
}